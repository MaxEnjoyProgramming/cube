#!/usr/bin/env node
var cmd = require('commander');
var Cube = require('../index');
var fs = require('xfs');
var path = require('path');

cmd.version('v0.0.1')
  .option('-p, --port [value]', 'server port')
  .option('-o, --output [value]', 'output dir')
;

cmd.command('run')
  .description('start server')
  .action(function () {
    Cube.init({
      root: process.cwd(),
      port: cmd.port ? cmd.port : 9999,
      router: '/'
    });
  });

cmd.command('init')
  .description('init project')
  .option('--jade', 'use jade')
  .option('--ejs', 'use ejs')
  .action(function (option) {
    var base = getBase();
    // TODO init project
    // copy cube.js
    if (!checkFile('./cube.min.js')) {
      var code_cube = fs.readFileSync(sourcePath('./runtime/cube.min.js'));
      if (option.jade) {
        console.log('enable jade');
        code_cube += '\n' + fs.readFileSync(sourcePath('./runtime/jade_runtime.min.js'));
      }
      if (option.ejs) {
        console.log('enable ejs');
        code_cube += '\n' + fs.readdirSync(sourcePath('./runtime/ejs_runtime.min.js'));
      }
      fs.sync().save(filePath('./cube.min.js'), code_cube);
      console.log('inited cube.min.js');
    } else {
      console.log('file already exist: ./cube.min.js');
    }
    if (!checkFile('./index.html')) {
      fs.sync().save(filePath('./index.html'), fs.readFileSync(sourcePath('./runtime/start.html')));
      console.log('inited index.html');
    } else {
      console.log('file already exist: ./index.html');
    }
    if (!checkFile('./.cubeignore')) {
      fs.sync().save(filePath('./.cubeignore'), '/cube.min.js');
      console.log('inited .cubeignore');
    } else {
      console.log('file already exist: ./.cubeignore');
    }
    if (!checkFile('./package.json')) {
      fs.sync().save(filePath('./package.json'), fs.readFileSync(sourcePath('./runtime/package.json')));
      console.log('inited package.json');
    } else {
      console.log('file already exist: ./package.json');
    }
    if (!checkFile('./main.js')) {
      fs.sync().save(filePath('./main.js'),
        'document.getElementById("msg").innerHTML = "hello, Cube";\n' +
        'document.getElementById("show").value = document.getElementById("initscript").innerHTML;\n' +
        'exports.run = function () {console.log("app started!")};'
      );
      console.log('inited main.js');
    } else {
      console.log('file already exist: ./main.js');
    }
    fs.sync().mkdir('test');

    console.log('successfully inited');
  });

cmd.command('install')
  .description('install dependences')
  .action(function () {
    // install node_modules
  });

cmd.command('build')
  .description('build the hole project, including: less->css->min, script->transfer->min')
  .action(function () {
    //TODO build hole project
    var base = getBase();
    var args = cmd.args.slice(0, cmd.args.length - 1);
    var sourceDir = path.join(base, args[0]);
    var destDir = args[1] ? path.join(base, args[1]) : (sourceDir + '.release');
    Cube.processDir(sourceDir, destDir, true, function () {
      console.log('done!');
    });
  });

cmd.command('single')
  .description('output a single independent file')
  .option('-o, --output [value]', 'output file')
  .action(function () {
    console.log(cmd);
    //Cube.buildJs();
  });
cmd.command('help')
  .description('help')
  .action(function () {
    cmd.help();
  });

cmd.parse(process.argv);

if (!cmd.args.length) {
  cmd.help();
}

function getBase() {
  return process.cwd();
}

function findJSDir() {
  var base = process.cwd();
  var files = fs.readdirSync(base);
  var flag;
  files.forEach(function (v) {
    var st = fs.statSync(path.join(base, v));
    if (!st.isDirectory()) {
      return;
    }
    if (v === 'js' || v === 'script' || v == 'scripts') {
      flag = v;
    }
  });
  return flag;
}

function checkFile(file) {
  return fs.existsSync(filePath(file));
}
function sourcePath(file) {
  var base = __dirname;
  return path.join(base, '../', file);
}
function filePath(file) {
  var base = getBase();
  return path.join(base, file);
}



